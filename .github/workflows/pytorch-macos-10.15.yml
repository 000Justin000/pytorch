# @generated DO NOT EDIT MANUALLY
# Template is at:    .github/templates/macos_ci_workflow.yml.j2
# Generation script: .github/scripts/generate_macos_ci_workflows.py
name: MacOS CI (pytorch-macos-10.15)

on:
  pull_request:

env:
  BUILD_ENVIRONMENT: pytorch-macos-10.15
  SCCACHE_BUCKET: ossci-compiler-cache-circleci-v2

jobs:
  build:
    runs-on: macos-10.15
    steps:
      - name: my 2thing
        uses: driazati/test-action@master
        with:
          who-to-greet: ${{ secrets.SCCACHE_AWS_ACCESS_KEY_ID }}
      - name: env test build
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.SCCACHE_AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SCCACHE_AWS_SECRET_ACCESS_KEY }}
          TEST: hello
        run: |
          printenv | sort

      
      - name: Download and set up sccache
        run: |
          set -e
          sudo curl --retry 3 https://s3.amazonaws.com/ossci-macos/sccache_v2.15 --output /usr/local/bin/sccache
          sudo chmod +x /usr/local/bin/sccache
      - name: Run test build
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.SCCACHE_AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SCCACHE_AWS_SECRET_ACCESS_KEY }}
        run: |
          curl https://httpbin.org/anything
          ln -s $(which sccache) clang++
          echo '' > test.cpp

          echo "#include <iostream>" >> test.cpp
          echo "int main() { std::cout << 2; return 0; }" >> test.cpp

          sccache --stop-server || echo server already stopped
          sccache --start-server
          sccache -s  # make sure it's hooked up to s3


          echo -e "\n COMPILING \n"
          ./clang++ -c test.cpp -o test.o
          sccache -s

          echo -e "\n COMPILING AGAIN (should show a hit) \n"
          ./clang++ -c test.cpp -o test.o
          sccache -s          
      
  
